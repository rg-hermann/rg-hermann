name: Generate Profile Metrics

on:
  schedule:
    - cron: '0 3 * * 1'  # Toda segunda-feira 03:00 UTC (~00:00 America/Sao_Paulo)
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Para commitar o SVG
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validar token de métricas
        id: token_check
        run: |
          if [ -n "${{ secrets.METRICS_TOKEN }}" ]; then
            echo "token_status=custom" >> $GITHUB_OUTPUT
            echo "Usando METRICS_TOKEN definido (tamanho: ${#METRICS_TOKEN})" | sed 's/./*/g'
          else
            echo "token_status=fallback" >> $GITHUB_OUTPUT
            echo "ATENÇÃO: METRICS_TOKEN não definido. Será usado GITHUB_TOKEN (recursos limitados)." >&2
          fi

      - name: Generate metrics
        if: steps.token_check.outputs.token_status == 'custom'
        id: metrics_custom
        continue-on-error: true
        uses: lowlighter/metrics@latest
        with:
          filename: assets/metrics.svg
          # Tenta usar o token customizado (ATENÇÃO: precisa ser PAT clássico, não fine-grained)
          token: ${{ secrets.METRICS_TOKEN }}
          user: rg-hermann
          template: classic
          base: header, activity, community, repositories, metadata
          config_timezone: America/Sao_Paulo
          plugin_lines: yes
          plugin_traffic: yes
          plugin_followup: yes
          plugin_repositories: yes
          plugin_languages: yes
          plugin_languages_ignored: >-
            html, css, scss, dockerfile
          plugin_languages_limit: 8
          plugin_languages_recent_days: 14
          plugin_languages_recent_load: 300
          plugin_languages_sections: most-used, recently-used
          plugin_achievements: yes
          plugin_achievements_secrets: yes
          plugin_achievements_threshold: C
          commits_authoring: rg-hermann,rodrigohermann18@outlook.com

      - name: Generate metrics (fallback GITHUB_TOKEN)
        if: |
          steps.token_check.outputs.token_status != 'custom' ||
          (steps.metrics_custom.outcome == 'failure')
        uses: lowlighter/metrics@latest
        with:
          filename: assets/metrics.svg
          # Fallback limitado: GITHUB_TOKEN (alguns plugins podem ter menos dados)
          token: ${{ github.token }}
          user: rg-hermann
          template: classic
          base: header, activity, community, repositories, metadata
          config_timezone: America/Sao_Paulo
          plugin_lines: yes
          plugin_traffic: yes
          plugin_followup: yes
          plugin_repositories: yes
          plugin_languages: yes
          plugin_languages_ignored: >-
            html, css, scss, dockerfile
          plugin_languages_limit: 8
          plugin_languages_recent_days: 14
          plugin_languages_recent_load: 300
          plugin_languages_sections: most-used, recently-used
          plugin_achievements: yes
          plugin_achievements_secrets: yes
          plugin_achievements_threshold: C
          commits_authoring: rg-hermann,rodrigohermann18@outlook.com

      - name: Commit metrics
        run: |
          if [[ `git status --porcelain assets/metrics.svg` ]]; then
            git config user.name 'github-actions'
            git config user.email 'github-actions@github.com'
            git add assets/metrics.svg
            git commit -m 'chore: update metrics.svg'
            git push
          else
            echo 'No changes in metrics.svg'
          fi
